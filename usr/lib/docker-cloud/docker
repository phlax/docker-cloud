#!/bin/bash -e

. /usr/lib/docker-cloud/common


dc_create_docker_env () {
    local docker_dir docker_user
    docker_dir="$1"
    docker_user="$2"
    mkdir -p "$docker_dir"
    chown apps:apps "$docker_dir"
    cd "$docker_dir"
    if [ -d "$docker_dir/bin" ]; then
	sudo -u apps bash -c "\
	  . bin/activate \
	    && if [ -f docker-compose.yml ]; then docker-compose pull; fi"
	return
    fi
    sudo -u apps bash -c "\
    	virtualenv . -p /usr/bin/python3 \
	  && . bin/activate \
	  && pip install docker-compose \
	  &&  if [ -f docker-compose.yml ]; then docker-compose pull; fi"
    bashrc="/home/${docker_user}/.bashrc"
    if grep -q "$docker_dir" bashrc; then
	echo ". $docker_dir/bin/activate" >> "$bashrc"
	echo "cd $docker_dir" >> "$bashrc"
    fi
}


dc_enable_firewall () {
    sed -i 's|[#]*startup=0|startup=1|g' /etc/default/shorewall
    sed -i 's|[#]*DOCKER=No|DOCKER=Yes|g' /etc/shorewall/shorewall.conf
    if systemctl is-system-running; then
	systemctl daemon-reload
	systemctl restart shorewall
    fi
}


dc_setup_systemd () {
    if systemctl is-system-running; then
	systemctl daemon-reload
    fi
    systemctl enable docker-cloud
}
